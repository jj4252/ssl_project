# Optimized Knowledge Distillation Training Config (with Cached Support)
# Designed for fast training: 20-40 minutes per epoch on A100/L4

# Training hyperparameters
batch_size: 64
num_epochs: 100
learning_rate: 0.0005  # 5e-4
weight_decay: 0.04
warmup_epochs: 10
min_lr: 1e-6

# Step-capped training (optional - limits batches per epoch)
# With samples_per_epoch=30000 and batch_size=64, we get ~468 batches per epoch
# max_steps_per_epoch=500 provides capacity for 32K images, so it covers all 30K samples
max_steps_per_epoch: 500  # Process up to 500 batches per epoch (covers all 30K samples)

# Distillation loss weights
distill_loss_weights:
  cls: 1.0      # CLS token loss weight
  patch: 0.5    # Patch token loss weight

# Data augmentation (simplified for speed)
use_multi_crop: false  # Use simple single-crop transform
use_local_crops: false  # Disable local crops (major speedup)

# Teacher feature caching (optional, major speedup)
cache_teacher_features: false  # Set to true to cache teacher features
teacher_feature_dir: "/scratch/$USER/ssl_project/cache/features"

# Optimization settings
compile_student: true   # Compile only student (never compile teacher)
use_fused_adamw: true   # Use fused AdamW optimizer

# DataLoader settings (optimized for Slurm)
num_workers: 2  # Reduced to prevent OOM (was 4)
persistent_workers: false  # Must be false to avoid KeyError
prefetch_factor: 1  # Reduced to prevent OOM (was 2)
pin_memory: true

# Checkpointing
checkpoint_dir: "/scratch/$USER/Nov_14_distill/checkpoints"
save_every: 100  # Save checkpoint every N steps (0 = only at end of epoch)

# SSL (Self-Supervised Learning) configuration
# Adds Barlow Twins loss on top of KD to improve feature discriminativeness
# RECOMMENDED: Enable with small weight (0.05) as anti-collapse regularizer
ssl:
  enabled: true   # Set to true to enable SSL (Barlow Twins) - RECOMMENDED for anti-collapse
  type: "barlow"  # SSL loss type (currently only "barlow" supported)
  weight: 0.05   # Weight for SSL loss: L_total = L_kd + weight * L_ssl (0.05 recommended, 0.5 was too high)
  barlow_lambd: 0.005  # Lambda for Barlow Twins off-diagonal term (default: 5e-3)
  proj_hidden_dim: 1024  # Hidden dimension for projection head
  proj_out_dim: 256      # Output dimension for projection head

